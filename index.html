<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --c:#005D4D; --c2:#00856b; --c3:#00a889;
            --bg:#f0f6f4; --surface:#ffffff; --border:#e2ebe8;
            --text:#1a2e2a; --sub:#5f7c76; --muted:#9bb0ab;
            --red:#d9434e; --red-bg:#fef2f2; --green:#16a34a; --green-bg:#f0fdf4;
            --R:16px;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans JP','DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}
        .ctr{max-width:1120px;margin:0 auto;padding:24px 16px}

        /* Header */
        .hdr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:32px}
        .hdr h1{font-size:26px;font-weight:900;color:var(--c);letter-spacing:-.5px}
        .hdr-sub{font-size:12px;color:var(--muted);margin-top:2px}
        .hdr-ctrl{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .b-icon{display:flex;align-items:center;gap:6px;padding:9px 16px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface);font-size:12px;font-weight:700;color:var(--sub);cursor:pointer;transition:all .2s;font-family:inherit;position:relative}
        .b-icon:hover{border-color:var(--c);color:var(--c)}
        .b-icon.on{border-color:var(--c);background:rgba(0,93,77,.04);color:var(--c)}
        .b-icon input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
        .b-pdf{display:flex;align-items:center;gap:6px;padding:9px 16px;border-radius:10px;border:none;background:var(--c);font-size:12px;font-weight:700;color:#fff;cursor:pointer;transition:all .2s;font-family:inherit}
        .b-pdf:hover{background:var(--c2)}
        .b-pdf:disabled{opacity:.4;cursor:not-allowed}
        select{padding:9px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-weight:700;background:var(--surface);color:var(--text);cursor:pointer;outline:none;font-family:inherit}
        select:focus{border-color:var(--c)}

        /* Upload hero */
        .uph{padding:60px 20px;text-align:center;background:var(--surface);border-radius:var(--R);border:2.5px dashed var(--border);cursor:pointer;transition:all .3s;position:relative}
        .uph:hover,.uph.drag{border-color:var(--c);background:rgba(0,93,77,.03)}
        .uph input{position:absolute;inset:0;opacity:0;cursor:pointer}
        .uph-t{font-size:17px;font-weight:800;margin:12px 0 6px}
        .uph-s{font-size:13px;color:var(--muted)}
        .uph-btn{display:inline-block;margin-top:16px;padding:8px 20px;background:var(--c);color:#fff;border-radius:8px;font-size:13px;font-weight:700;pointer-events:none}

        /* Card */
        .card{background:var(--surface);border-radius:var(--R);border:1.5px solid var(--border);overflow:hidden}
        .card-h{padding:18px 22px 0;font-size:13px;font-weight:800;display:flex;align-items:center;gap:8px}
        .card-b{padding:14px 22px 22px}

        /* Summary */
        .sum-r{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
        .sum-c{border-radius:var(--R);padding:22px;cursor:pointer;transition:all .2s;overflow:hidden}
        .sum-c:active{transform:scale(.98)}
        .sum-c.inc{background:var(--c);color:#fff}
        .sum-c.inc:hover{background:#004d40}
        .sum-c.exp{background:var(--red);color:#fff}
        .sum-c.exp:hover{background:#c13040}
        .sum-c.bal{background:var(--surface);border:1.5px solid var(--border);cursor:default}
        .sum-c.bal:active{transform:none}
        .sum-l{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;opacity:.75;margin-bottom:6px}
        .sum-c.bal .sum-l{color:var(--sub);opacity:1}
        .sum-v{font-family:'DM Sans';font-size:30px;font-weight:800;letter-spacing:-1px}
        .sum-c.bal .sum-v{color:var(--text)}
        .sum-n{font-size:11px;margin-top:6px;opacity:.6}
        .sum-c.bal .sum-n{color:var(--sub);opacity:1}

        /* Grids */
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
        .g-ca{display:grid;grid-template-columns:3fr 2fr;gap:14px;margin-bottom:20px}

        /* Tables */
        table{width:100%;border-collapse:collapse;font-size:13px}
        th{text-align:left;font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;padding:8px 10px;border-bottom:1.5px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:1}
        th.r,td.r{text-align:right}
        td{padding:9px 10px;border-bottom:1px solid #f1f5f3}
        tr.ck{cursor:pointer;transition:background .15s}
        tr.ck:hover{background:rgba(0,93,77,.04)}
        .scr{max-height:320px;overflow-y:auto}

        /* Advice */
        .adv{padding:11px 13px;border-radius:10px;margin-bottom:6px;font-size:13px;font-weight:600}
        .adv.i{background:#eff6ff;color:#1e40af}
        .adv.w{background:#fffbeb;color:#92400e}
        .adv.g{background:var(--green-bg);color:#166534}
        .adv.b{background:var(--red-bg);color:#991b1b}
        .adv-s{font-size:11px;font-weight:500;margin-top:3px;opacity:.8}

        /* Forecast */
        .fc-r{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .fc{padding:18px;border-radius:12px;background:var(--bg);border-left:4px solid var(--c)}
        .fc.gr{border-left-color:var(--green)}.fc.bl{border-left-color:#2563eb}
        .fc-l{font-size:10px;font-weight:800;color:var(--sub);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px}
        .fc-v{font-family:'DM Sans';font-size:24px;font-weight:800;letter-spacing:-.5px}
        .fc-n{font-size:11px;color:var(--muted);margin-top:3px}

        /* Monthly */
        .mo{display:flex;align-items:center;gap:12px;padding:7px 0;border-bottom:1px solid #f1f5f3;font-size:13px}
        .mo:last-child{border-bottom:none}
        .mo-l{font-weight:600;min-width:70px}
        .mo-a{display:flex;gap:14px;margin-left:auto;font-family:'DM Sans';font-weight:600;font-size:12px}
        .mo-i{color:var(--green)}.mo-e{color:var(--red)}

        /* Top cat */
        .tc{padding:12px;border-radius:12px;background:var(--bg);margin-bottom:8px}
        .tc-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .tc-n{font-weight:700;font-size:14px}
        .tc-v{font-family:'DM Sans';font-weight:800;font-size:15px}
        .tc-bar{height:5px;border-radius:3px;background:#e2ebe8;overflow:hidden}
        .tc-fill{height:100%;border-radius:3px;background:var(--c);transition:width .6s}

        /* â•â•â• Modal â•â•â• */
        .mo-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:1000}
        .mo-ov.on{display:flex;align-items:center;justify-content:center}
        .modal{background:var(--surface);border-radius:20px;width:92%;max-width:680px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 24px 48px rgba(0,0,0,.15);animation:mIn .2s ease}
        .m-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1.5px solid var(--border);flex-shrink:0}
        .m-ttl{font-size:15px;font-weight:800;display:flex;align-items:center;gap:8px}
        .m-x{width:34px;height:34px;border-radius:10px;border:none;background:var(--bg);color:var(--sub);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
        .m-x:hover{background:#e2ebe8;color:var(--text)}
        .m-body{padding:20px 22px;overflow-y:auto;flex:1}

        .m-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px}
        .m-st{text-align:center;padding:12px;background:var(--bg);border-radius:10px}
        .m-st-l{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
        .m-st-v{font-family:'DM Sans';font-size:20px;font-weight:800;margin-top:2px}

        /* Drill row â€” matches screenshot style */
        .dr{display:flex;align-items:center;padding:16px 18px;border-radius:12px;margin-bottom:4px;cursor:pointer;transition:all .15s;border:1.5px solid transparent}
        .dr:hover{background:rgba(0,93,77,.03);border-color:var(--border)}
        .dr:active{transform:scale(.99)}
        .dr-icon{width:32px;height:32px;border-radius:8px;background:#f5deb3;display:flex;align-items:center;justify-content:center;font-size:15px;margin-right:14px;flex-shrink:0}
        .dr-icon.month{background:#e0f2fe}
        .dr-name{font-weight:700;font-size:14px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .dr-right{text-align:right;margin-left:12px;flex-shrink:0}
        .dr-amt{font-family:'DM Sans';font-weight:800;font-size:16px;color:var(--text)}
        .dr-pct{font-size:11px;color:var(--muted);margin-top:1px}
        .dr-chev{color:var(--muted);font-size:18px;margin-left:8px;flex-shrink:0}

        /* Breadcrumb */
        .bc{display:flex;align-items:center;gap:6px;margin-bottom:16px;flex-wrap:wrap}
        .bc-b{padding:5px 12px;border-radius:7px;border:1.5px solid var(--border);background:var(--surface);font-size:11px;font-weight:700;color:var(--c);cursor:pointer;transition:all .15s;font-family:inherit}
        .bc-b:hover{background:var(--bg);border-color:var(--c)}
        .bc-s{color:var(--muted);font-size:11px}
        .bc-c{font-size:12px;font-weight:700}

        @keyframes mIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

        .pdf-ov{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,93,77,.12);backdrop-filter:blur(2px);align-items:center;justify-content:center}
        .pdf-ov.on{display:flex}
        .pdf-sp{font-size:15px;font-weight:700;color:var(--c);background:#fff;padding:20px 32px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.1)}

        @media(max-width:768px){
            .sum-r{grid-template-columns:1fr}.sum-v{font-size:24px}
            .g2,.g-ca{grid-template-columns:1fr}.fc-r{grid-template-columns:1fr}
            .hdr{flex-direction:column;align-items:flex-start}
            .modal{width:96%;max-height:90vh}.m-stats{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
<div class="ctr" id="root">
    <div class="hdr">
        <div><h1>Money Tracker</h1><p class="hdr-sub" id="msg">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æ</p></div>
        <div class="hdr-ctrl">
            <div class="b-icon" id="hdrUp"><span>ğŸ“</span><span>CSVè¿½åŠ </span><input type="file" id="fi" multiple accept=".csv"></div>
            <select id="ps"><option value="all">å…¨æœŸé–“</option></select>
            <button class="b-pdf" id="pb" disabled onclick="exportPDF()"><span>ğŸ“„</span><span>PDFå‡ºåŠ›</span></button>
        </div>
    </div>
    <div id="empty" class="uph" ondragover="dh(event,1)" ondragleave="dh(event,0)" ondrop="dd(event)">
        <input type="file" id="fi2" multiple accept=".csv">
        <div style="font-size:40px">ğŸ“‚</div>
        <div class="uph-t">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
        <div class="uph-s">ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ç­‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œã€‚è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«OKã€‚</div>
        <div class="uph-btn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ or ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
    </div>
    <div id="dash" style="display:none">
        <div class="sum-r">
            <div class="sum-c inc" onclick="openL1('income')"><div class="sum-l">åå…¥</div><div class="sum-v" id="vInc">Â¥0</div><div class="sum-n">ã‚¿ãƒƒãƒ—ã§å†…è¨³ â†’</div></div>
            <div class="sum-c exp" onclick="openL1('expense')"><div class="sum-l">æ”¯å‡º</div><div class="sum-v" id="vExp">Â¥0</div><div class="sum-n">ã‚¿ãƒƒãƒ—ã§å†…è¨³ â†’</div></div>
            <div class="sum-c bal"><div class="sum-l">åæ”¯</div><div class="sum-v" id="vBal">Â¥0</div><div class="sum-n" id="vMsg">åå…¥ âˆ’ æ”¯å‡º</div></div>
        </div>
        <div class="g-ca">
            <div class="card"><div class="card-h">æ”¯å‡ºå‰²åˆ</div><div class="card-b"><div style="position:relative;height:260px"><canvas id="chart"></canvas></div></div></div>
            <div class="card"><div class="card-h">ğŸ’¡ ç¯€ç´„ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div><div class="card-b" id="advice"></div></div>
        </div>
        <div class="g2">
            <div class="card"><div class="card-h">ğŸ”¥ ãƒãƒªãƒ„ãƒ¢åˆ†æï¼ˆä¸­é …ç›®ï¼‰</div><div class="card-b"><p style="font-size:11px;color:var(--muted);margin-bottom:10px">å›æ•°ãŒå¤šã„ã‚«ãƒ†ã‚´ãƒªã€‚ã‚¯ãƒªãƒƒã‚¯ã§æ˜ç´°ã€‚</p><div class="scr"><table><thead><tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th class="r">ä»¶æ•°</th><th class="r">åˆè¨ˆ</th></tr></thead><tbody id="rkSub"></tbody></table></div></div></div>
            <div class="card"><div class="card-h">ğŸª ã‚ˆãåˆ©ç”¨ã™ã‚‹åº—èˆ—</div><div class="card-b"><p style="font-size:11px;color:var(--muted);margin-bottom:10px">åˆ©ç”¨å›æ•°ãŒå¤šã„ã‚‚ã®ã€‚ã‚¯ãƒªãƒƒã‚¯ã§æ˜ç´°ã€‚</p><div class="scr"><table><thead><tr><th>å†…å®¹</th><th class="r">ä»¶æ•°</th><th class="r">åˆè¨ˆ</th></tr></thead><tbody id="rkCon"></tbody></table></div></div></div>
        </div>
        <div class="card" style="margin-bottom:20px"><div class="card-h">ğŸ“ˆ æ¥å¹´ã®äºˆç®—è¨ˆç”»</div><div class="card-b">
            <div class="fc-r">
                <div class="fc"><div class="fc-l">å¹´é–“æ”¯å‡ºäºˆæ¸¬</div><div class="fc-v" id="fA">Â¥0</div><div class="fc-n">ç¾åœ¨ã®æœŸé–“ã‹ã‚‰æ¨è¨ˆ</div></div>
                <div class="fc gr"><div class="fc-l">æ¨å¥¨å¹´å</div><div class="fc-v" id="fS">Â¥0</div><div class="fc-n">æ”¯å‡ºã®1.3å€ç›®å®‰</div></div>
                <div class="fc bl"><div class="fc-l">æœˆé¡ç›®å®‰</div><div class="fc-v" id="fM">Â¥0</div><div class="fc-n">æ¯æœˆã®å¿…è¦åå…¥</div></div>
            </div>
            <p style="font-size:11px;color:var(--sub);margin-top:14px;padding:10px;background:var(--bg);border-radius:8px">ğŸ’¡ æ¨å¥¨å¹´åã¯æ”¯å‡ºã®1.3å€ã€‚ç¨é‡‘ãƒ»ç¤¾ä¼šä¿é™ºæ–™ãƒ»è²¯é‡‘ãƒ»ä½™è£•è³‡é‡‘ã‚’è€ƒæ…®ã€‚</p>
        </div></div>
        <div class="g2">
            <div class="card"><div class="card-h">ğŸ“Š æœˆåˆ¥ã‚µãƒãƒªãƒ¼</div><div class="card-b"><div id="mSum" class="scr"></div></div></div>
            <div class="card"><div class="card-h">ğŸ¯ æ”¯å‡ºã‚«ãƒ†ã‚´ãƒª TOP 3</div><div class="card-b" id="top3"></div></div>
        </div>
    </div>
</div>

<div class="mo-ov" id="ov" onclick="if(event.target===this)closeM()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="m-hdr"><div class="m-ttl" id="mTtl">å†…è¨³</div><button class="m-x" onclick="closeM()">âœ•</button></div>
        <div class="m-body" id="mBody"></div>
    </div>
</div>
<div class="pdf-ov" id="pov"><div class="pdf-sp">ğŸ“„ PDFç”Ÿæˆä¸­...</div></div>

<script>
let D=[],F=[],CI=null,incCat={},expCat={};
const $=id=>document.getElementById(id);
const fmt=n=>'Â¥'+Math.abs(n).toLocaleString('ja-JP');
const esc=s=>s.replace(/'/g,"\\'").replace(/"/g,'&quot;');

/* â”€â”€ File I/O â”€â”€ */
function pf(files){
    if(!files.length)return;
    let done=0,raw=[],tot=files.length;
    for(let i=0;i<tot;i++) readF(files[i],t=>{
        raw=raw.concat(Papa.parse(t,{header:true,skipEmptyLines:true}).data);
        if(++done===tot)addData(raw);
    });
}
function readF(f,cb){
    const r=new FileReader();
    r.onload=e=>{
        const t=e.target.result;
        if(t.includes('æ—¥ä»˜')||t.includes('é‡‘é¡')||t.includes('ID'))return cb(t);
        const r2=new FileReader();r2.onload=e2=>cb(e2.target.result);r2.readAsText(f,'Shift_JIS');
    };
    r.readAsText(f,'UTF-8');
}
$('fi').onchange=e=>{pf(e.target.files);e.target.value=''};
$('fi2').onchange=e=>{pf(e.target.files);e.target.value=''};
$('ps').onchange=function(){upd(this.value)};
function dh(e,on){e.preventDefault();e.currentTarget.classList.toggle('drag',on)}
function dd(e){e.preventDefault();e.currentTarget.classList.remove('drag');if(e.dataTransfer.files.length)pf(e.dataTransfer.files)}

function addData(raw){
    const pr=raw.map(r=>{
        const n={};Object.keys(r).forEach(k=>{n[k.replace(/\s+/g,'').replace(/ï¼ˆ/g,'(').replace(/ï¼‰/g,')')]=r[k]});
        return{...r,ID:n.ID||r.ID||'','æ—¥ä»˜':n['æ—¥ä»˜']||r['æ—¥ä»˜']||'','å¤§é …ç›®':n['å¤§é …ç›®']||r['å¤§é …ç›®']||'','ä¸­é …ç›®':n['ä¸­é …ç›®']||r['ä¸­é …ç›®']||'','å†…å®¹':n['å†…å®¹']||r['å†…å®¹']||'','é‡‘é¡ï¼ˆå††ï¼‰':parseInt(n['é‡‘é¡(å††)']||n['é‡‘é¡']||r['é‡‘é¡ï¼ˆå††ï¼‰']||0,10),'è¨ˆç®—å¯¾è±¡':parseInt(n['è¨ˆç®—å¯¾è±¡']||r['è¨ˆç®—å¯¾è±¡']||0,10)};
    });
    const ids=new Set(D.map(r=>r.ID).filter(Boolean));
    D=D.concat(pr.filter(r=>!(r.ID&&ids.has(r.ID))));
    $('msg').textContent=D.length?`${D.length.toLocaleString('ja-JP')} ä»¶èª­ã¿è¾¼ã¿æ¸ˆã¿`:'æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™';
    if(!D.length)return;
    $('hdrUp').classList.add('on');$('empty').style.display='none';$('dash').style.display='block';$('pb').disabled=false;
    const yrs=new Set();D.forEach(r=>{if(r['æ—¥ä»˜']){const y=r['æ—¥ä»˜'].split('/')[0];if(y&&!isNaN(y))yrs.add(y)}});
    const s=$('ps'),c=s.value;s.innerHTML='<option value="all">å…¨æœŸé–“</option>';
    [...yrs].sort().reverse().forEach(y=>{s.innerHTML+=`<option value="${y}">${y}å¹´</option>`});
    s.value=[...yrs].includes(c)||c==='all'?c:'all';upd(s.value);
}

function upd(period){
    let data=D;if(period!=='all')data=D.filter(r=>r['æ—¥ä»˜']&&r['æ—¥ä»˜'].startsWith(period));
    F=data;let tI=0,tE=0,ic={},ec={},sc={},dc={},mo={};
    data.forEach(r=>{
        const a=r['é‡‘é¡ï¼ˆå††ï¼‰'],cat=r['å¤§é …ç›®']||'ä¸æ˜',sub=r['ä¸­é …ç›®']||'ä¸æ˜',con=r['å†…å®¹']||'ä¸æ˜',tg=r['è¨ˆç®—å¯¾è±¡']===1,d=r['æ—¥ä»˜']||'';
        if(d){const mk=d.substring(0,7);if(!mo[mk])mo[mk]={i:0,e:0};if(a>0&&tg)mo[mk].i+=a;if(a<0&&tg)mo[mk].e+=Math.abs(a)}
        if(a>0){if(tg)tI+=a;ic[cat]=(ic[cat]||0)+a}
        else if(a<0&&tg){tE+=Math.abs(a);ec[cat]=(ec[cat]||0)+Math.abs(a);
            if(!sc[sub])sc[sub]={c:0,a:0};sc[sub].c++;sc[sub].a+=Math.abs(a);
            if(!dc[con])dc[con]={c:0,a:0};dc[con].c++;dc[con].a+=Math.abs(a)}
    });
    incCat=ic;expCat=ec;
    $('vInc').textContent=fmt(tI);$('vExp').textContent=fmt(tE);
    const b=tI-tE;$('vBal').textContent=(b>=0?'':'-')+fmt(b);$('vMsg').textContent=b>=0?'é»’å­— ğŸ‘':'èµ¤å­—ã§ã™ã€‚è¦‹ç›´ã—ã‚’ã€‚';
    rChart(ec);rRank('rkSub',sc);rRank('rkCon',dc);
    rAdvice(tI,tE,ec,sc);rForecast(period);rMonth(mo);rTop3(ec);
}

/* â•â•â•â•â•â• MODAL â•â•â•â•â•â• */
function showM(){$('ov').classList.add('on');document.body.style.overflow='hidden'}
function closeM(){$('ov').classList.remove('on');document.body.style.overflow=''}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeM()});

/* â”€â”€â”€ L1: å¤§é …ç›® list â”€â”€â”€ */
function openL1(type){
    $('mTtl').textContent=type==='income'?'ğŸ’° åå…¥ã®å†…è¨³':'ğŸ“Š æ”¯å‡ºã®å†…è¨³';
    const cats=type==='income'?incCat:expCat;
    const sorted=Object.entries(cats).sort((a,b)=>b[1]-a[1]).filter(([,v])=>v>0);
    const body=$('mBody');
    if(!sorted.length){body.innerHTML='<p style="text-align:center;color:var(--muted);padding:40px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';showM();return}
    const total=sorted.reduce((s,i)=>s+i[1],0);
    body.innerHTML=sorted.map(([name,val])=>{
        const pct=((val/total)*100).toFixed(1);
        return drRow(name,fmt(val),pct+'%','ğŸ“','',`openL2('${esc(name)}','${type}')`);
    }).join('');
    showM();
}

/* â”€â”€â”€ L2: ä¸­é …ç›® list â”€â”€â”€ */
function openL2(catName,type){
    $('mTtl').textContent=catName;
    const txns=F.filter(r=>{
        const a=r['é‡‘é¡ï¼ˆå††ï¼‰'],t=r['è¨ˆç®—å¯¾è±¡']===1,c=r['å¤§é …ç›®']||'ä¸æ˜';
        return type==='income'?(a>0&&t&&c===catName):(a<0&&t&&c===catName);
    });
    const bySub={};
    txns.forEach(r=>{const s=r['ä¸­é …ç›®']||'ä¸æ˜';if(!bySub[s])bySub[s]={c:0,a:0};bySub[s].c++;bySub[s].a+=Math.abs(r['é‡‘é¡ï¼ˆå††ï¼‰'])});
    const sorted=Object.entries(bySub).sort((a,b)=>b[1].a-a[1].a);
    const total=sorted.reduce((s,i)=>s+i[1].a,0);
    const bc=`<div class="bc"><button class="bc-b" onclick="openL1('${type}')">â† ${type==='income'?'åå…¥':'æ”¯å‡º'}</button><span class="bc-s">â€º</span><span class="bc-c">${catName}</span></div>`;
    $('mBody').innerHTML=bc+sorted.map(([name,st])=>{
        const pct=((st.a/total)*100).toFixed(1);
        return drRow(name,fmt(st.a),pct+'%  Â·  '+st.c+'ä»¶','ğŸ“','',`openL3Cat('${esc(catName)}','${esc(name)}','${type}')`);
    }).join('');
}

/* â”€â”€â”€ L3: æœˆåˆ¥ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆå¤§é …ç›®+ä¸­é …ç›®ãƒ•ã‚£ãƒ«ã‚¿ï¼‰â”€â”€â”€ */
function openL3Cat(catName,subName,type){
    $('mTtl').textContent=subName;
    const txns=F.filter(r=>{
        const a=r['é‡‘é¡ï¼ˆå††ï¼‰'],t=r['è¨ˆç®—å¯¾è±¡']===1,c=r['å¤§é …ç›®']||'ä¸æ˜',s=r['ä¸­é …ç›®']||'ä¸æ˜';
        return type==='income'?(a>0&&t&&c===catName&&s===subName):(a<0&&t&&c===catName&&s===subName);
    });
    const bc=`<div class="bc">
        <button class="bc-b" onclick="openL1('${type}')">â† ${type==='income'?'åå…¥':'æ”¯å‡º'}</button><span class="bc-s">â€º</span>
        <button class="bc-b" onclick="openL2('${esc(catName)}','${type}')">${catName}</button><span class="bc-s">â€º</span>
        <span class="bc-c">${subName}</span></div>`;
    renderMonthFolders($('mBody'),txns,bc,function(month){
        return `openL4Cat('${esc(catName)}','${esc(subName)}','${month}','${type}')`;
    });
}

/* â”€â”€â”€ L4: æ˜ç´°ï¼ˆå¤§é …ç›®+ä¸­é …ç›®+æœˆï¼‰â”€â”€â”€ */
function openL4Cat(catName,subName,month,type){
    const txns=F.filter(r=>{
        const a=r['é‡‘é¡ï¼ˆå††ï¼‰'],t=r['è¨ˆç®—å¯¾è±¡']===1,c=r['å¤§é …ç›®']||'ä¸æ˜',s=r['ä¸­é …ç›®']||'ä¸æ˜',mk=(r['æ—¥ä»˜']||'').substring(0,7);
        return mk===month&&t&&c===catName&&s===subName&&(type==='income'?a>0:a<0);
    });
    const bc=`<div class="bc">
        <button class="bc-b" onclick="openL1('${type}')">â† ${type==='income'?'åå…¥':'æ”¯å‡º'}</button><span class="bc-s">â€º</span>
        <button class="bc-b" onclick="openL2('${esc(catName)}','${type}')">${catName}</button><span class="bc-s">â€º</span>
        <button class="bc-b" onclick="openL3Cat('${esc(catName)}','${esc(subName)}','${type}')">${subName}</button><span class="bc-s">â€º</span>
        <span class="bc-c">${month}</span></div>`;
    renderTxnTable($('mBody'),txns,bc);
}

/* â”€â”€â”€ Ranking drill: L1â†’monthsâ†’æ˜ç´° â”€â”€â”€ */
function openRkL1(itemName,filterType){
    $('mTtl').textContent='ğŸ“ '+itemName;
    const txns=F.filter(r=>{
        const a=r['é‡‘é¡ï¼ˆå††ï¼‰'],t=r['è¨ˆç®—å¯¾è±¡']===1;
        if(!t||a>=0)return false;
        return filterType==='sub'?(r['ä¸­é …ç›®']||'ä¸æ˜')===itemName:(r['å†…å®¹']||'ä¸æ˜')===itemName;
    });
    const bc=`<div class="bc"><span class="bc-c">ğŸ“ ${itemName}</span></div>`;
    renderMonthFolders($('mBody'),txns,bc,function(month){
        return `openRkL2('${esc(itemName)}','${month}','${filterType}')`;
    });
    showM();
}

function openRkL2(itemName,month,filterType){
    const txns=F.filter(r=>{
        const a=r['é‡‘é¡ï¼ˆå††ï¼‰'],t=r['è¨ˆç®—å¯¾è±¡']===1,mk=(r['æ—¥ä»˜']||'').substring(0,7);
        if(mk!==month||!t||a>=0)return false;
        return filterType==='sub'?(r['ä¸­é …ç›®']||'ä¸æ˜')===itemName:(r['å†…å®¹']||'ä¸æ˜')===itemName;
    });
    const bc=`<div class="bc">
        <button class="bc-b" onclick="openRkL1('${esc(itemName)}','${filterType}')">â† ${itemName}</button><span class="bc-s">â€º</span>
        <span class="bc-c">${month}</span></div>`;
    renderTxnTable($('mBody'),txns,bc);
}

/* â•â•â• Shared renderers â•â•â• */
function drRow(name,amount,sub,icon,iconCls,onclick){
    return `<div class="dr" onclick="${onclick}">
        <div class="dr-icon ${iconCls}">${icon}</div>
        <div class="dr-name">${name}</div>
        <div class="dr-right"><div class="dr-amt">${amount}</div><div class="dr-pct">${sub}</div></div>
        <div class="dr-chev">â€º</div>
    </div>`;
}

function renderMonthFolders(container,txns,bcHTML,onClickFn){
    const byM={};
    txns.forEach(r=>{const mk=(r['æ—¥ä»˜']||'').substring(0,7)||'ä¸æ˜';if(!byM[mk])byM[mk]={c:0,a:0};byM[mk].c++;byM[mk].a+=Math.abs(r['é‡‘é¡ï¼ˆå††ï¼‰'])});
    const sorted=Object.entries(byM).sort((a,b)=>b[0].localeCompare(a[0]));
    const total=txns.reduce((s,t)=>s+Math.abs(t['é‡‘é¡ï¼ˆå††ï¼‰']),0);
    container.innerHTML=bcHTML+
        `<div class="m-stats">
            <div class="m-st"><div class="m-st-l">ä»¶æ•°</div><div class="m-st-v">${txns.length}</div></div>
            <div class="m-st"><div class="m-st-l">åˆè¨ˆ</div><div class="m-st-v">${fmt(total)}</div></div>
            <div class="m-st"><div class="m-st-l">å¹³å‡/æœˆ</div><div class="m-st-v">${fmt(Math.round(total/Math.max(1,sorted.length)))}</div></div>
        </div>`+
        sorted.map(([m,st])=>drRow(m,fmt(st.a),st.c+'ä»¶','ğŸ“…','month',onClickFn(m))).join('');
}

function renderTxnTable(container,txns,bcHTML){
    const total=txns.reduce((s,t)=>s+Math.abs(t['é‡‘é¡ï¼ˆå††ï¼‰']),0);
    const sorted=txns.sort((a,b)=>new Date(b['æ—¥ä»˜'].replace(/\//g,'-'))-new Date(a['æ—¥ä»˜'].replace(/\//g,'-')));
    container.innerHTML=bcHTML+
        `<div class="m-stats">
            <div class="m-st"><div class="m-st-l">ä»¶æ•°</div><div class="m-st-v">${txns.length}</div></div>
            <div class="m-st"><div class="m-st-l">åˆè¨ˆ</div><div class="m-st-v">${fmt(total)}</div></div>
            <div class="m-st"><div class="m-st-l">å¹³å‡</div><div class="m-st-v">${fmt(Math.round(total/Math.max(1,txns.length)))}</div></div>
        </div>
        <div class="scr" style="max-height:300px"><table>
            <thead><tr><th>æ—¥ä»˜</th><th>å†…å®¹</th><th class="r">é‡‘é¡</th></tr></thead>
            <tbody>${sorted.map(r=>{
                const d=r['æ—¥ä»˜']||'',c=r['å†…å®¹']||'ä¸æ˜',sub=r['ä¸­é …ç›®']||'',a=Math.abs(r['é‡‘é¡ï¼ˆå††ï¼‰']);
                return `<tr><td style="font-size:12px;color:var(--sub);white-space:nowrap">${d}</td>
                <td><div style="font-weight:600">${c}</div>${sub?`<div style="font-size:11px;color:var(--muted);margin-top:1px">${sub}</div>`:''}</td>
                <td class="r" style="font-family:'DM Sans';font-weight:700;white-space:nowrap">${fmt(a)}</td></tr>`;
            }).join('')}</tbody>
        </table></div>`;
}

/* â•â•â•â•â•â• Rankings â•â•â•â•â•â• */
function rRank(id,obj){
    const tb=$(id);tb.innerHTML='';const ft=id==='rkSub'?'sub':'con';
    Object.entries(obj).filter(([k])=>k!=='ä¸æ˜'&&k!=='').sort((a,b)=>b[1].c-a[1].c).slice(0,15).forEach(([k,s])=>{
        tb.innerHTML+=`<tr class="ck" onclick="openRkL1('${esc(k)}','${ft}')">
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:600" title="${k}">${k}</td>
            <td class="r" style="font-weight:600;color:var(--sub)">${s.c}</td>
            <td class="r" style="font-family:'DM Sans';font-weight:700">${fmt(s.a)}</td></tr>`;
    });
}

/* â•â•â•â•â•â• Chart â•â•â•â•â•â• */
function rChart(obj){
    const ctx=$('chart').getContext('2d');const sorted=Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    if(CI)CI.destroy();
    const cols=['#005D4D','#00856b','#00a889','#d9434e','#e67e22','#f59e0b','#eab308','#16a34a','#2563eb','#7c3aed','#0891b2','#475569'];
    CI=new Chart(ctx,{type:'doughnut',data:{labels:sorted.map(i=>i[0]),datasets:[{data:sorted.map(i=>i[1]),backgroundColor:cols.slice(0,sorted.length),borderWidth:3,borderColor:'#fff'}]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'right',labels:{boxWidth:10,font:{size:11,weight:'600',family:"'Noto Sans JP'"},padding:8,usePointStyle:true,pointStyle:'circle'}}}}});
}

/* â•â•â•â•â•â• Advice â•â•â•â•â•â• */
function rAdvice(tI,tE,ec,sc){
    const el=$('advice');if(!tE){el.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';return}
    const fd=ec['é£Ÿè²»']||0,fR=(fd/tE)*100,tc=ec['é€šä¿¡è²»']||0,sR=tI>0?((tI-tE)/tI*100):0;
    let h='';
    if(tI>0)h+=`<div class="adv i">è²¯è“„ç‡ <strong>${sR>=0?sR.toFixed(1):'-'+Math.abs(sR).toFixed(1)}%</strong></div>`;
    if(fR>25)h+=`<div class="adv b">ğŸš¨ é£Ÿè²» ${fR.toFixed(1)}%<div class="adv-s">å¤–é£Ÿãƒ»ã‚³ãƒ³ãƒ“ãƒ‹ã‚’è¦‹ç›´ã—</div></div>`;
    else if(fR>15)h+=`<div class="adv w">âš ï¸ é£Ÿè²» ${fR.toFixed(1)}%</div>`;
    else h+=`<div class="adv g">âœ… é£Ÿè²» ${fR.toFixed(1)}%</div>`;
    if(tc>15000)h+=`<div class="adv w">ğŸ“ é€šä¿¡è²» ${fmt(tc)}<div class="adv-s">æ ¼å®‰ãƒ—ãƒ©ãƒ³æ¤œè¨ã‚’</div></div>`;
    const ts=Object.entries(sc).sort((a,b)=>b[1].c-a[1].c).filter(x=>x[0]!=='ä¸æ˜')[0];
    if(ts&&ts[1].c>5)h+=`<div class="adv w">ğŸ’¡ã€Œ${ts[0]}ã€${ts[1].c}å›<div class="adv-s">ãƒãƒªãƒ„ãƒ¢æ³¨æ„</div></div>`;
    el.innerHTML=h;
}

/* â•â•â•â•â•â• Forecast â•â•â•â•â•â• */
function rForecast(period){
    let tE=0;F.forEach(r=>{if(r['è¨ˆç®—å¯¾è±¡']===1&&r['é‡‘é¡ï¼ˆå††ï¼‰']<0)tE+=Math.abs(r['é‡‘é¡ï¼ˆå††ï¼‰'])});
    let an;
    if(period==='all'){
        const ds=F.filter(r=>r['æ—¥ä»˜']).map(r=>r['æ—¥ä»˜']).sort();
        if(!ds.length){$('fA').textContent=$('fS').textContent=$('fM').textContent='Â¥0';return}
        const f=new Date(ds[0].replace(/\//g,'-')),l=new Date(ds[ds.length-1].replace(/\//g,'-'));
        an=Math.round(tE/Math.max(1,(l.getFullYear()-f.getFullYear())*12+l.getMonth()-f.getMonth()+1))*12;
    }else an=tE;
    const sg=Math.round(an*1.3);
    $('fA').textContent=fmt(an);$('fS').textContent=fmt(sg);$('fM').textContent=fmt(Math.round(sg/12));
}

/* â•â•â•â•â•â• Monthly â•â•â•â•â•â• */
function rMonth(mo){
    const el=$('mSum');const ks=Object.keys(mo).sort().reverse().slice(0,12);
    if(!ks.length){el.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';return}
    el.innerHTML=ks.map(m=>`<div class="mo"><span class="mo-l">${m}</span><div class="mo-a"><span class="mo-i">+${fmt(mo[m].i)}</span><span class="mo-e">-${fmt(mo[m].e)}</span></div></div>`).join('');
}

/* â•â•â•â•â•â• Top 3 â•â•â•â•â•â• */
function rTop3(ec){
    const el=$('top3');const s=Object.entries(ec).sort((a,b)=>b[1]-a[1]).slice(0,3);
    if(!s.length){el.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';return}
    const mx=s[0][1];const md=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    el.innerHTML=s.map(([n,v],i)=>`<div class="tc"><div class="tc-h"><span class="tc-n">${md[i]} ${n}</span><span class="tc-v">${fmt(v)}</span></div><div class="tc-bar"><div class="tc-fill" style="width:${((v/mx)*100).toFixed(0)}%"></div></div></div>`).join('');
}

/* â•â•â•â•â•â• PDF â•â•â•â•â•â• */
async function exportPDF(){
    $('pov').classList.add('on');
    try{
        await new Promise(r=>setTimeout(r,100));
        const cv=await html2canvas($('root'),{scale:2,useCORS:true,backgroundColor:'#f0f6f4',logging:false});
        const{jsPDF}=window.jspdf;const pW=210,pH=(cv.height*pW)/cv.width;
        const pdf=new jsPDF({orientation:'p',unit:'mm',format:[pW,Math.max(pH,297)]});
        pdf.addImage(cv.toDataURL('image/png'),'PNG',0,0,pW,pH);
        const p=$('ps').value;pdf.save(`Money_Tracker_${p==='all'?'å…¨æœŸé–“':p+'å¹´'}.pdf`);
    }catch(e){console.error(e);alert('PDFå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚')}
    $('pov').classList.remove('on');
}
</script>
</body>
</html>
